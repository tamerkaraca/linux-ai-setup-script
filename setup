#!/bin/bash

# Windows CRLF düzeltme kontrolü
if [ -f "$0" ]; then
    if file "$0" | grep -q "CRLF"; then
        echo "Windows satır sonu karakterleri tespit edildi, düzeltiliyor..."
        
        if command -v dos2unix &> /dev/null; then
            dos2unix "$0"
        elif command -v sed &> /dev/null; then
            sed -i 's/\r$//' "$0"
        elif command -v tr &> /dev/null; then
            tr -d '\r' < "$0" > "$0.tmp" && mv "$0.tmp" "$0"
        fi
        
        chmod +x "$0"
        
        echo "Düzeltme tamamlandı, script yeniden başlatılıyor..."
        exec bash "$0" "$@"
    fi
fi

SCRIPT_BASE_URL="${SCRIPT_BASE_URL:-https://raw.githubusercontent.com/tamerkaraca/linux-ai-setup-script/main}"

source_module() {
    local local_path="$1"
    local remote_rel_path="$2"
    if [ -f "$local_path" ]; then
        # shellcheck source=/dev/null
        source "$local_path"
    else
        if ! command -v curl &> /dev/null; then
            echo "[HATA] 'curl' komutu bulunamadı; $remote_rel_path dosyası yüklenemiyor."
            exit 1
        fi
        local remote_url="${SCRIPT_BASE_URL}/${remote_rel_path}"
        # shellcheck disable=SC1090
        source <(curl -fsSL "$remote_url") || {
            echo "[HATA] $remote_url dosyası yüklenemedi."
            exit 1
        }
    fi
}

source_module "./modules/utils.sh" "modules/utils.sh"
source_module "./modules/banner.sh" "modules/banner.sh"
BASE_URL="${BASE_URL:-${SCRIPT_BASE_URL}/modules}"
export BASE_URL

REMOTE_MODULE_DIR=""

prepare_remote_module_dir() {
    if [ -n "$REMOTE_MODULE_DIR" ]; then
        return 0
    fi
    REMOTE_MODULE_DIR="$(mktemp -d)"
    mkdir -p "$REMOTE_MODULE_DIR/modules"
    curl -fsSL "${SCRIPT_BASE_URL}/modules/utils.sh" -o "$REMOTE_MODULE_DIR/modules/utils.sh" || return 1
    curl -fsSL "${SCRIPT_BASE_URL}/modules/banner.sh" -o "$REMOTE_MODULE_DIR/modules/banner.sh" || true
    return 0
}

cleanup_remote_modules() {
    if [ -n "$REMOTE_MODULE_DIR" ] && [ -d "$REMOTE_MODULE_DIR" ]; then
        rm -rf "$REMOTE_MODULE_DIR"
    fi
}
trap cleanup_remote_modules EXIT

# Script çalıştırma fonksiyonu
run_module() {
    local module_name="$1"
    local local_path="./modules/${module_name}.sh"
    local module_url="$BASE_URL/$module_name.sh"
    shift

    if [ -f "$local_path" ]; then
        echo -e "${CYAN}[BİLGİ]${NC} $module_name modülü yerel dosyadan çalıştırılıyor..."
        if ! PKG_MANAGER="$PKG_MANAGER" UPDATE_CMD="$UPDATE_CMD" INSTALL_CMD="$INSTALL_CMD" bash "$local_path" "$@"; then
            echo -e "${RED}[HATA]${NC} $module_name modülü çalıştırılırken bir hata oluştu."
            return 1
        fi
    else
        echo -e "${CYAN}[BİLGİ]${NC} $module_name modülü indiriliyor ve çalıştırılıyor..."
        prepare_remote_module_dir || {
            echo -e "${RED}[HATA]${NC} Uzaktan modül dizini hazırlanamadı."
            return 1
        }
        local remote_file="$REMOTE_MODULE_DIR/${module_name}.sh"
        if [ ! -f "$remote_file" ]; then
            if ! curl -fsSL "$module_url" -o "$remote_file"; then
                echo -e "${RED}[HATA]${NC} $module_name modülü indirilemedi."
                return 1
            fi
        fi
        if ! (cd "$REMOTE_MODULE_DIR" && PKG_MANAGER="$PKG_MANAGER" UPDATE_CMD="$UPDATE_CMD" INSTALL_CMD="$INSTALL_CMD" bash "$remote_file" "$@"); then
            echo -e "${RED}[HATA]${NC} $module_name modülü çalıştırılırken bir hata oluştu."
            return 1
        fi
    fi
    return 0
}
export -f run_module
export -f prepare_remote_module_dir
export -f cleanup_remote_modules

# Ana menü
main_menu() {
    detect_package_manager # Paket yöneticisini başta tespit et
    
    while true; do
        clear
        render_setup_banner "1.0.0" "https://github.com/tamerkaraca/linux-ai-setup-script"
        
        echo -e "${BLUE}╔═══════════════════════════════════════════════╗${NC}"
        echo -e "${BLUE}║                 ANA KURULUM MENÜSÜ            ║${NC}"
        echo -e "${BLUE}╚═══════════════════════════════════════════════╝${NC}\n"
        echo -e "  ${GREEN}1${NC} - Sistemi Güncelle ve Temel Paketleri Kur"
        echo -e "  ${GREEN}2${NC} - Python ve İlgili Araçları Kur (Pip, Pipx, UV)"
        echo -e "  ${GREEN}3${NC} - Node.js ve İlgili Araçları Kur (NVM, Bun.js)"
        echo -e "  ${GREEN}4${NC} - AI CLI Araçlarını Kur (Claude Code, Gemini CLI, vb.)"
        echo -e "  ${GREEN}5${NC} - AI Frameworklerini Kur (SuperGemini, SuperQwen, SuperClaude)"
        echo -e "  ${GREEN}6${NC} - Git Yapılandırması"
        echo -e "  ${GREEN}7${NC} - GLM-4.6 Claude Code Yapılandırması"
        echo -e "  ${GREEN}8${NC} - PHP ve Composer Kurulumu"
        echo -e "  ${GREEN}9${NC} - GitHub CLI Kurulumu"
        echo -e "  ${GREEN}10${NC} - AI Frameworklerini Kaldır"
        echo -e "  ${GREEN}11${NC} - MCP Sunucu Yönetimi"
        echo -e "  ${GREEN}A${NC} - Hepsini Kur (Sırayla)"
        echo -e "  ${RED}0${NC} - Çıkış"
        echo -e "\n${YELLOW}[BİLGİ]${NC} Birden fazla seçim için virgülle ayırabilirsiniz (örn: 1,4,5)."
        echo
        read -r -p "${YELLOW}Seçiminiz:${NC} " choice_input </dev/tty

        if [ -z "$(echo "$choice_input" | tr -d '[:space:]')" ]; then
            echo -e "${YELLOW}[UYARI]${NC} Bir seçim yapmadınız, lütfen tekrar deneyin."
            sleep 1
            continue
        fi

        IFS=',' read -ra USER_CHOICES <<< "$choice_input"
        exit_menu=false

        for raw_choice in "${USER_CHOICES[@]}"; do
            choice=$(echo "$raw_choice" | tr -d '[:space:]')
            [ -z "$choice" ] && continue
            choice=$(echo "$choice" | tr '[:lower:]' '[:upper:]')

            case "$choice" in
                1) update_system ;;
                2) run_module "install_python_tools" ;; # Bu modül Python, Pip, Pipx, UV kuracak
                3) run_module "install_nodejs_tools" ;; # Bu modül NVM, Bun.js kuracak
                4) run_module "install_ai_cli_tools_menu" ;;
                5) run_module "install_ai_frameworks_menu" ;;
                6) run_module "configure_git" ;;
                7) run_module "configure_glm_claude" ;;
                8) run_module "install_php_composer" ;; # Bu modül PHP ve Composer kuracak
                9) run_module "install_github_cli" ;;
                10) run_module "remove_ai_frameworks_menu" ;;
                11) run_module "manage_mcp_servers_menu" ;;
                A)
                    update_system
                    run_module "install_python_tools"
                    run_module "install_nodejs_tools"
                    run_module "install_ai_cli_tools_menu" "all" # "all" parametresi ile tüm CLI araçlarını kur
                    run_module "install_ai_frameworks_menu" "all" # "all" parametresi ile tüm frameworkleri kur
                    run_module "configure_git"
                    run_module "configure_glm_claude"
                    run_module "install_github_cli"
                    echo -e "\n${YELLOW}PHP ve Composer kurulsun mu? (e/h)${NC}"
                    read -r install_php_choice </dev/tty
                    if [[ "$install_php_choice" =~ ^[EeYy]$ ]]; then
                        run_module "install_php_composer"
                    fi
                    ;;
                0)
                    echo -e "${GREEN}[BİLGİ]${NC} Çıkılıyor. Güle güle!"
                    exit_menu=true
                    break
                    ;;
                *)
                    echo -e "${RED}[HATA]${NC} Geçersiz seçim: $raw_choice"
                    ;;
            esac
        done

        if [ "$exit_menu" = true ]; then
            exit 0
        fi
        echo -e "\n${YELLOW}Devam etmek için Enter'a basın...${NC}"
        read -r </dev/tty
    done
}

# Script başladığında ana menüyü çağır
main_menu
